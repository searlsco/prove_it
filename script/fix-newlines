#!/usr/bin/env bash
# Ensure every staged text file ends with a newline.
# Skips binary files automatically (git diff --diff-filter).
set -e

fixed=0
while IFS= read -r file; do
  [ -z "$file" ] && continue
  [ ! -f "$file" ] && continue
  # Skip binary files
  if file --brief --mime "$file" | grep -qv '^text/'; then
    continue
  fi
  # Check if file is non-empty and missing trailing newline
  if [ -s "$file" ] && [ "$(tail -c1 "$file" | wc -l)" -eq 0 ]; then
    printf '\n' >> "$file"
    git add "$file"
    fixed=$((fixed + 1))
  fi
done < <(git diff --cached --name-only --diff-filter=ACM)

if [ "$fixed" -gt 0 ]; then
  echo "fix-newlines: added trailing newline to $fixed file(s)"
fi
